<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');//zona horariadate_default_timezone_set('America/Mexico_City');//Clase control login  class login extends CI_Controller {//constructor de la clase	function __construct(){		parent::__construct();		$this->load->model('login_model');//Llamada al modelo login                $this->load->model('productos_model');//Llamada al modelo productos	}//Funcion index para el logueo de BACK-END	public function index(){                            //If para logueo del administrador		if($this->session->userdata('is_logged_in')){                        			$this->load->view('constant');//Llamada a la vista constantes                       			$this->load->view('view_header');//Llamada a la vista header                         //Llamado a fucion pedidos abiertos y al macenarlos en arreglo data                        $data['documentos'] = $this->productos_model->getPedidosAbiertos();                        //Llamado a fucion estadisticas de pedidos                         $data['documentos2'] = $this->productos_model->getEstatisticas();                        //Llamado a fucion productos minimo y al macenarlos en arreglo data                        $data['productos'] = $this->productos_model->getProductosMinimo();                        			$this->load->view('view_home', $data);//Llamada a la vista de home y arreglo data de productos con stock minimo			$this->load->view('view_footer');//Llamada a la vista footer                        		}else{                    //else para logueo del administrador			$this->load->view('constant');//Llamada a la vista constantes			$this->load->view('view_login');//Llamada a la vista de login                                                $this->load->view('view_footer');//Llamada a la vista de footer		}	}//Funcion cerrar sesion para terminar la sesion activa del usuario logueado 	 function CerrarSesion(){          /*destrozamos la sesion activa nos vamos al login de nuevo*/          if($this->session->userdata('is_logged_in')){               $this->session->sess_destroy();                redirect('login', 'refresh');          }    }//Funcion valida acceso para validar los campos 	public function ValidaAcceso(){		session_start();		$Login 		= json_decode($this->input->post('LoginPost'));            //array de response para errores		$response = array (		    "campo"     => "",	            "error_msg" => ""	    );        //if para validacion del campo email	    if($Login->UserName==""){			$response["campo"]     = "email";			$response["error_msg"]   = "<div class='alert alert-danger text-center' alert-dismissable> <button type='button' class='close' data-dismiss='alert'>&times;</button>La Correo es Obligatorio</div>";		}else if($Login->Password==""){//if para validacion del campo password			$response["campo"]     = "password";			$response["error_msg"]   = "<div class='alert alert-danger text-center' alert-dismissable><button type='button' class='close' data-dismiss='alert'>&times;</button>La Contrase単a es obligatorio</div>";		}else{                       //Llamado a funcion loginBD del modelo login			$user = $this->login_model->LoginBD($Login->UserName);                         			if(count($user) == 1){				$crypt     = crypt($Login->Password, $user->PASSWORD);  				if($user->PASSWORD==$crypt){					 $tipoUser= "Administrador";					 if($user->TIPO==2){$tipoUser="Vendedor";}					 $session = array(                         'ID'           => $user->ID,                         'NOMBRE'       => $user->NOMBRE,                         'APELLIDOS'    => $user->APELLIDOS,                         'EMAIL'        => $Login->UserName,                         'TIPOUSUARIO'  => $user->TIPO,                         'TIPOUSUARIOMS'=> $tipoUser,                         'is_logged_in' => TRUE,                                          );                                //Llamado a funcion creaMenu del modelo login			        $Menu = $this->login_model->CreaMenu($user->ID);			        //$Menu = json_encode($Menu);				$this->session->set_userdata($session);//Cargamos la sesion de datos del usuario logeado	                $_SESSION['Menu'] = $Menu;//cargamos la sesion del menu de acuerdo a los permisos	                $response["error_msg"]   = '<meta http-equiv="refresh" content="0">';				}else{                                    //Mensaje de contrase単a invalida					$response["error_msg"]   = "<div class='alert alert-danger text-center' alert-dismissable><button type='button' class='close' data-dismiss='alert'>&times;</button>La Contrase単a Contrase単a es Invalida  </div>";				}			}else{                            //Mensaje de email invalido				$response["error_msg"]   = "<div class='alert alert-danger text-center' alert-dismissable><button type='button' class='close' data-dismiss='alert'>&times;</button>El Email es Invalida </div>";			}		}		echo json_encode($response);	}               }